on:
  push:
    branches:
    - master
    tags-ignore:
    - v*
  pull_request:
    branches:
    - master
    types:
    - assigned
    - opened
    - synchronize
    - reopened

name: Build, lint and test

jobs:
  # check:
  #   name: Check
  #   runs-on: ubuntu-20.04
  #   steps:
  #   - name: Checkout sources
  #     uses: actions/checkout@v2

  #   - name: Install stable toolchain
  #     uses: actions-rs/toolchain@v1
  #     with:
  #       profile: minimal
  #       toolchain: stable
  #       override: true

  #   - name: Run cargo check
  #     uses: actions-rs/cargo@v1
  #     with:
  #       command: check

  test:
    name: Test Suite
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2
    - uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true

    # - name: Run cargo test
    #   uses: actions-rs/cargo@v1
    #   with:
    #     command: test
    - uses: actions/setup-python@v2
      with:
        python-version: "3.8"

    - name: Install python deps
      run: pip3 install -r tests/requirements.txt --user

    - name: Run integration tests
      env:
        AIOHTTP_NO_EXTENSIONS: 1
      run: |
        cargo build
        python3 -m pytest \
          --swindon-bin=$(pwd)/target/debug/swindon \
          --swindon-config=$(pwd)/tests/config.yaml.tpl \
          --swindon-replication-config=$(pwd)/tests/config-w-replication.yaml.tpl \
          -rsxvvX -k "base_redir"

  # lints:
  #   name: Lints
  #   runs-on: ubuntu-20.04
  #   steps:
  #   - name: Checkout sources
  #     uses: actions/checkout@v2

  #   - name: Install stable toolchain
  #     uses: actions-rs/toolchain@v1
  #     with:
  #       profile: minimal
  #       toolchain: stable
  #       override: true
  #       components: rustfmt, clippy

  #   - name: Run cargo clippy
  #     uses: actions-rs/cargo@v1
  #     with:
  #       command: clippy
  #       args: -- -D warnings
